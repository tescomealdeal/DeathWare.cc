package me.zeroeightsix.kami.module.modules.exploit;

import java.awt.Color;
import java.util.function.Predicate;
import me.zero.alpine.listener.EventHandler;
import me.zero.alpine.listener.Listener;
import me.zeroeightsix.kami.event.events.PacketEvent;
import me.zeroeightsix.kami.event.events.RenderEvent;
import me.zeroeightsix.kami.module.Module;
import me.zeroeightsix.kami.setting.Setting;
import me.zeroeightsix.kami.setting.Settings;
import me.zeroeightsix.kami.util.KamiTessellator;
import me.zeroeightsix.kami.util.ReflectionHelper;
import net.minecraft.init.Blocks;
import net.minecraft.item.Item;
import net.minecraft.network.play.client.CPacketCloseWindow;
import net.minecraft.network.play.client.CPacketPlayerTryUseItemOnBlock;
import net.minecraft.tileentity.TileEntityHopper;
import net.minecraft.util.math.BlockPos;
import org.lwjgl.opengl.GL11;

@Module.Info(name="IllegalItemBypass", category=Module.Category.EXPLOITS, description="Illegal Item Bypass")
public class IllegalItemBypass
        extends Module {
    private Setting<Boolean> circleOwn = this.register(Settings.b("Draw Circle for own 32k Hopper", true));
    private Setting<Boolean> circleOthers = this.register(Settings.b("Draw Circle for other Hoppers", true));
    private Setting<Integer> circleMaxRange = this.register(Settings.i("Circle max Range", 64));
    private BlockPos ownHopper = null;
    @EventHandler
    public Listener<PacketEvent.Send> listener = new Listener<PacketEvent.Send>(event -> {
        BlockPos clickTarget;
        if (this.isDisabled()) {
            return;
        }
        if (event.getPacket() instanceof CPacketCloseWindow) {
            event.cancel();
        }
        if (event.getPacket() instanceof CPacketPlayerTryUseItemOnBlock && IllegalItemBypass.mc.player.getHeldItemMainhand().getItem() == Item.getItemFromBlock(Blocks.HOPPER) && IllegalItemBypass.mc.world.getBlockState(clickTarget = ((CPacketPlayerTryUseItemOnBlock)event.getPacket()).getPos()).getBlock() != Blocks.HOPPER) {
            this.ownHopper = clickTarget.add(0, 1, 0);
        }
    }, new Predicate[0]);

    @Override
    public void onWorldRender(RenderEvent event) {
        if (this.circleOwn.getValue().booleanValue() && this.ownHopper != null && IllegalItemBypass.mc.player.getDistance(this.ownHopper.x, this.ownHopper.y, this.ownHopper.z) <= (double)this.circleMaxRange.getValue().intValue()) {
            this.drawRange(this.ownHopper, (float)Color.GREEN.getRed() / 255.0f, (float)Color.GREEN.getGreen() / 255.0f, (float)Color.BLUE.getBlue() / 255.0f);
        }
        if (this.circleOthers.getValue().booleanValue()) {
            for (Object tileEntity : IllegalItemBypass.mc.world.loadedTileEntityList) {
                if (!(tileEntity instanceof TileEntityHopper)) continue;
                BlockPos targetHopper = ((TileEntityHopper)tileEntity).getPos();
                if (IllegalItemBypass.mc.player.getDistance(targetHopper.x, targetHopper.y, targetHopper.z) > (double)this.circleMaxRange.getValue().intValue() || this.ownHopper != null && ((TileEntityHopper)tileEntity).getPos().equals(this.ownHopper)) continue;
                this.drawRange(targetHopper, (float)Color.RED.getRed() / 255.0f, (float)Color.ORANGE.getGreen() / 255.0f, (float)Color.ORANGE.getBlue() / 255.0f);
            }
        }
    }

    private void drawRange(BlockPos blockPos, float red, float green, float blue) {
        KamiTessellator.prepare(7);
        double x = (double)blockPos.getX() + 0.5 - ReflectionHelper.getRenderPosX();
        double y = (double)blockPos.getY() - ReflectionHelper.getRenderPosY();
        double z = (double)blockPos.getZ() + 0.5 - ReflectionHelper.getRenderPosZ();
        GL11.glPushMatrix();
        GL11.glBlendFunc(770, 771);
        GL11.glEnable(3042);
        GL11.glLineWidth(2.0f);
        GL11.glDisable(3553);
        GL11.glDisable(2929);
        GL11.glDepthMask(false);
        GL11.glColor4d(red, green, blue, 0.2);
        GL11.glBegin(9);
        for (int i = 0; i <= 360; ++i) {
            GL11.glVertex3d(x + Math.sin((double)i * 3.1415 / 180.0) * 7.0, y, z + Math.cos((double)i * 3.1415 / 180.0) * 7.0);
        }
        GL11.glEnd();
        GL11.glLineWidth(2.0f);
        GL11.glEnable(3553);
        GL11.glEnable(2929);
        GL11.glDepthMask(true);
        GL11.glDisable(3042);
        GL11.glPopMatrix();
        GL11.glColor4f(1.0f, 1.0f, 1.0f, 1.0f);
        KamiTessellator.release();
    }
}
